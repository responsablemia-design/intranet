# Arquitectura del Sistema - Intranet IES FÃ©lix de Azara

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE (Navegador)                         â”‚
â”‚                  https://intranet.iesfelixdeazara.com              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TRAEFIK (Puerto 80/443)                     â”‚
â”‚                   âœ“ Reverse Proxy + SSL (Let's Encrypt)            â”‚
â”‚                                                                     â”‚
â”‚   Rutas:                                                            â”‚
â”‚   â€¢ /api, /auth  â†’  API Backend (puerto 3000)                      â”‚
â”‚   â€¢ /*           â†’  Frontend Web (puerto 3001)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                â”‚
             â†“                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API BACKEND              â”‚  â”‚   FRONTEND WEB                    â”‚
â”‚   (Fastify + TypeScript)   â”‚  â”‚   (SvelteKit + TypeScript)        â”‚
â”‚   Puerto: 3000             â”‚  â”‚   Puerto: 3001                    â”‚
â”‚                            â”‚  â”‚                                   â”‚
â”‚   Rutas:                   â”‚  â”‚   PÃ¡ginas:                        â”‚
â”‚   â€¢ GET  /auth/me          â”‚  â”‚   â€¢ /login                        â”‚
â”‚   â€¢ GET  /auth/google      â”‚  â”‚   â€¢ /dashboard                    â”‚
â”‚   â€¢ GET  /api/incidencias  â”‚  â”‚   â€¢ /incidencias                  â”‚
â”‚   â€¢ POST /api/incidencias  â”‚  â”‚   â€¢ /incidencias/nueva            â”‚
â”‚   â€¢ GET  /api/espacios     â”‚  â”‚   â€¢ /incidencias/[id]             â”‚
â”‚   â€¢ ...                    â”‚  â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                
             â†“                                
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MARIADB 11.4             â”‚  â”‚   REDIS 7                         â”‚
â”‚   Base de datos relacional â”‚  â”‚   Cache + Sesiones                â”‚
â”‚                            â”‚  â”‚                                   â”‚
â”‚   Tablas:                  â”‚  â”‚   Almacena:                       â”‚
â”‚   â€¢ users                  â”‚  â”‚   â€¢ Sesiones de usuario           â”‚
â”‚   â€¢ espacios               â”‚  â”‚   â€¢ Cookies de autenticaciÃ³n      â”‚
â”‚   â€¢ equipos                â”‚  â”‚                                   â”‚
â”‚   â€¢ incidencias            â”‚  â”‚                                   â”‚
â”‚   â€¢ comentarios            â”‚  â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Flujo de AutenticaciÃ³n (Google OAuth2)

```
Usuario                 Frontend               API Backend           Google OAuth2
  |                        |                        |                      |
  |---(1) Clic "Login"--â†’  |                        |                      |
  |                        |---(2) Redirect------â†’  |                      |
  |                        |                        |---(3) Redirect----â†’  |
  |                        |                        |                      |
  |  â†------------------(4) Pantalla de login Google----------------------|
  |                        |                        |                      |
  |---(5) Autoriza----------------------------------------------â†’          |
  |                        |                        |  â†--(6) Callback-----|
  |                        |                        |                      |
  |                        |  â†--(7) Cookie sesiÃ³n--|                      |
  |  â†--(8) Redirect a /dashboard-----------------  |                      |
```

## Flujo de CreaciÃ³n de Incidencia

```
Usuario                 Frontend               API Backend           Base de Datos
  |                        |                        |                      |
  |--Navega a /incidencias/nueva-â†’                  |                      |
  |                        |                        |                      |
  |                        |--GET /api/espacios--â†’  |                      |
  |                        |                        |--Query espacios---â†’  |
  |                        |  â†--Lista de espacios--|  â†--Resultados-------|
  |                        |                        |                      |
  |--Rellena formulario-â†’  |                        |                      |
  |                        |                        |                      |
  |--Submit formulario--â†’  |                        |                      |
  |                        |--POST /api/incidenciasâ†’|                      |
  |                        |  {titulo, desc, ...}   |--INSERT incidenciaâ†’  |
  |                        |                        |  â†--ID nueva inc.----|
  |                        |                        |                      |
  |                        |                        |--Email a admins---â†’  ğŸ“§
  |                        |                        |                      |
  |                        |  â†--{incidencia creada}|                      |
  |  â†--Redirect a /incidencias/[id]---------------  |                      |
```

## Diagrama de Base de Datos (Simplificado)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     User        â”‚         â”‚   Incidencia     â”‚         â”‚   Espacio       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id              â”‚â—„â”€â”€â”€â”€â”   â”‚ id               â”‚    â”Œâ”€â”€â†’ â”‚ id              â”‚
â”‚ googleId        â”‚     â”‚   â”‚ titulo           â”‚    â”‚    â”‚ codigo          â”‚
â”‚ email           â”‚     â””â”€â”€â”€â”‚ autorId          â”‚    â”‚    â”‚ nombre          â”‚
â”‚ name            â”‚         â”‚ asignadoId       â”‚â”€â”€â”€â”€â”˜    â”‚ planta          â”‚
â”‚ role            â”‚     â”Œâ”€â”€â”€â”‚ espacioId        â”‚         â”‚ tipo            â”‚
â”‚ active          â”‚     â”‚   â”‚ equipoId         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚ estado           â”‚                 â”‚
                        â”‚   â”‚ prioridad        â”‚                 â”‚
                        â”‚   â”‚ descripcion      â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   â”‚ createdAt        â”‚         â”‚    Equipo       â”‚
                        â”‚   â”‚ resolvedAt       â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ id              â”‚
                        â”‚             â”‚                  â”‚ nombre          â”‚
                        â”‚             â”‚                  â”‚ tipo            â”‚
                        â”‚             â”‚                  â”‚ estado          â”‚
                        â”‚             â”‚                  â”‚ espacioId       â”‚
                        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚   â”‚  Comentario    â”‚
                        â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚   â”‚ id             â”‚
                        â””â”€â”€â”€â”‚ autorId        â”‚
                            â”‚ incidenciaId   â”‚
                            â”‚ contenido      â”‚
                            â”‚ createdAt      â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Componentes Docker

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker Compose Stack                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”“  â”â”â”â”â”â”â”â”â”â”â”â”“  â”â”â”â”â”â”â”â”â”â”“  â”â”â”â”â”â”â”â”â”“  â”â”â”â”â”â”â”â”â”“ â”‚
â”‚  â”ƒ  traefik  â”ƒ  â”ƒ  mariadb â”ƒ  â”ƒ  redis â”ƒ  â”ƒ   api â”ƒ  â”ƒ  web  â”ƒ â”‚
â”‚  â”ƒ           â”ƒ  â”ƒ          â”ƒ  â”ƒ        â”ƒ  â”ƒ       â”ƒ  â”ƒ       â”ƒ â”‚
â”‚  â”ƒ  v3.3     â”ƒ  â”ƒ  11.4    â”ƒ  â”ƒ  7-alp â”ƒ  â”ƒ Node  â”ƒ  â”ƒ Node  â”ƒ â”‚
â”‚  â”ƒ           â”ƒ  â”ƒ          â”ƒ  â”ƒ        â”ƒ  â”ƒ 22    â”ƒ  â”ƒ 22    â”ƒ â”‚
â”‚  â”—â”â”â”â”â”â”â”â”â”â”â”â”›  â”—â”â”â”â”â”â”â”â”â”â”â”›  â”—â”â”â”â”â”â”â”â”â”›  â”—â”â”â”â”â”â”â”â”›  â”—â”â”â”â”â”â”â”â”› â”‚
â”‚       â”‚              â”‚             â”‚           â”‚          â”‚       â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                          Red: intranet                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Puertos Expuestos

- **80** â†’ HTTP (redirige a HTTPS)
- **443** â†’ HTTPS (punto de entrada principal)
- Puertos internos (no expuestos al exterior):
  - 3000 â†’ API Backend
  - 3001 â†’ Frontend Web
  - 3306 â†’ MariaDB
  - 6379 â†’ Redis

## Variables de Entorno Clave

```bash
# Dominio
DOMAIN=iesfelixdeazara.com

# Base de datos
DB_NAME=intranet
DB_USER=intranet_user
DB_PASSWORD=[secreto]

# Sesiones
SESSION_SECRET=[secreto]

# Google OAuth2
GOOGLE_CLIENT_ID=[tu-client-id]
GOOGLE_CLIENT_SECRET=[secreto]

# Email (Let's Encrypt)
ACME_EMAIL=responsablemia@iesfelixdeazara.com
```

## Stack TecnolÃ³gico

### Backend
- **Framework:** Fastify 5.x
- **Lenguaje:** TypeScript
- **ORM:** Prisma 6.x
- **AutenticaciÃ³n:** Passport + Google OAuth2
- **Sesiones:** connect-redis + ioredis
- **Email:** Nodemailer

### Frontend
- **Framework:** SvelteKit 2.x
- **Lenguaje:** TypeScript
- **Build:** Vite 6.x
- **Adapter:** @sveltejs/adapter-node

### Base de Datos
- **Motor:** MariaDB 11.4
- **Estrategia:** Prisma db push (sin migraciones)

### Infraestructura
- **Contenedores:** Docker + Docker Compose
- **Proxy:** Traefik v3
- **SSL:** Let's Encrypt (automÃ¡tico)
- **Cache:** Redis 7
